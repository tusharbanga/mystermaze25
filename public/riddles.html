<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>Harry Potter Riddle Quest</title>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Harry+P&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
Â  Â  <style>
Â  Â  Â  Â  /* [ORIGINAL CSS STYLES ARE RETAINED HERE] */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  background: url('greathall.png') no-repeat center center fixed;
Â  Â  Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  Â  Â  font-family: 'MedievalSharp', cursive;
Â  Â  Â  Â  Â  Â  color: #FFD700;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  overflow-x: hidden;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  touch-action: manipulation;
Â  Â  Â  Â  }
Â  Â  Â  Â  #parallax-bg {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  z-index: -1;
Â  Â  Â  Â  Â  Â  background: url('greathall.png') no-repeat center center;
Â  Â  Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  Â  Â  transform: translateZ(-1px) scale(1.2);
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header {
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.7);
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid #FFD700;
Â  Â  Â  Â  Â  Â  position: sticky;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.8);
Â  Â  Â  Â  Â  Â  border-left: 2px solid #FFD700;
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  perspective: 1000px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-height: 40vh;
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  border-top: 2px solid #FFD700;
Â  Â  Â  Â  Â  Â  z-index: 20;
Â  Â  Â  Â  Â  Â  transform: translateY(100%);
Â  Â  Â  Â  }
Â  Â  Â  Â  .sidebar.open {
Â  Â  Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  Â  }
Â  Â  Â  Â  .sidebar-toggle {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 1rem;
Â  Â  Â  Â  Â  Â  right: 1rem;
Â  Â  Â  Â  Â  Â  z-index: 30;
Â  Â  Â  Â  Â  Â  background: #FFD700;
Â  Â  Â  Â  Â  Â  color: #1a1a1a;
Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px rgba(255,215,0,0.8);
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 768px) {
Â  Â  Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  Â  Â  width: 20rem;
Â  Â  Â  Â  Â  Â  Â  Â  max-height: none;
Â  Â  Â  Â  Â  Â  Â  Â  position: static;
Â  Â  Â  Â  Â  Â  Â  Â  border-top: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-left: 2px solid #FFD700;
Â  Â  Â  Â  Â  Â  Â  Â  transform: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .sidebar-toggle {
Â  Â  Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  .main-content {
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  min-height: calc(100vh - 4rem);
Â  Â  Â  Â  }
Â  Â  Â  Â  .riddle-card {
Â  Â  Â  Â  Â  Â  perspective: 2000px;
Â  Â  Â  Â  Â  Â  transform-style: preserve-3d;
Â  Â  Â  Â  Â  Â  animation: float 6s ease-in-out infinite;
Â  Â  Â  Â  Â  Â  margin-bottom: 2rem;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  max-width: 28rem;
Â  Â  Â  Â  Â  Â  height: 24rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 640px) {
Â  Â  Â  Â  Â  Â  .riddle-card {
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 32rem;
Â  Â  Â  Â  Â  Â  Â  Â  height: 28rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-inner {
Â  Â  Â  Â  Â  Â  transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
Â  Â  Â  Â  Â  Â  transform-style: preserve-3d;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 20px rgba(255,215,0,0.3);
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-front, .card-back {
Â  Â  Â  Â  Â  Â  backface-visibility: hidden;
Â  Â  Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, rgba(139,0,0,0.9), rgba(0,0,0,0.9));
Â  Â  Â  Â  Â  Â  border: 2px solid #FFD700;
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 0 10px #FFD700;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card-back {
Â  Â  Â  Â  Â  Â  transform: rotateY(180deg);
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, rgba(0,100,0,0.9), rgba(0,0,0,0.9));
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-map {
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 0.25rem;
Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  Â  Â  max-width: 90%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-icon {
Â  Â  Â  Â  Â  Â  transition: transform 0.5s ease, color 0.3s;
Â  Â  Â  Â  Â  Â  animation: pulse 2s infinite;
Â  Â  Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .progress-icon.completed {
Â  Â  Â  Â  Â  Â  transform: scale(1.3) rotate(360deg);
Â  Â  Â  Â  Â  Â  animation: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-item {
Â  Â  Â  Â  Â  Â  transition: background 0.3s, transform 0.2s;
Â  Â  Â  Â  Â  Â  transform-style: preserve-3d;
Â  Â  Â  Â  Â  Â  transform: rotateX(5deg) rotateY(10deg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 5px 20px rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  animation: leaderboard-float 4s ease-in-out infinite;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaderboard-item:hover {
Â  Â  Â  Â  Â  Â  background: rgba(255,215,0,0.3);
Â  Â  Â  Â  Â  Â  transform: translateX(5px) rotateX(0deg) rotateY(0deg);
Â  Â  Â  Â  }
Â  Â  Â  Â  .parallax {
Â  Â  Â  Â  Â  Â  transition: transform 0.2s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-glow {
Â  Â  Â  Â  Â  Â  transition: box-shadow 0.3s;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 20rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .input-glow:focus {
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 15px #FFD700;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-glow {
Â  Â  Â  Â  Â  Â  transition: box-shadow 0.3s, transform 0.2s;
Â  Â  Â  Â  Â  Â  padding: 0.5rem 1.5rem;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-glow:hover {
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px #FFD700;
Â  Â  Â  Â  Â  Â  transform: scale(1.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  #get-riddle-btn {
Â  Â  Â  Â  Â  Â  perspective: 1000px;
Â  Â  Â  Â  Â  Â  transform-style: preserve-3d;
Â  Â  Â  Â  Â  Â  animation: button-float 4s ease-in-out infinite;
Â  Â  Â  Â  Â  Â  background: linear-gradient(135deg, #FFD700, #DAA520);
Â  Â  Â  Â  Â  Â  border: 3px solid #FFD700;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 30px rgba(255,215,0,0.8), inset 0 0 15px rgba(255,255,255,0.4);
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 10px rgba(0,0,0,0.7);
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease, box-shadow 0.3s ease;
Â  Â  Â  Â  Â  Â  padding: 0.75rem 2rem;
Â  Â  Â  Â  Â  Â  font-size: 1.25rem;
Â  Â  Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  Â  Â  color: #1a1a1a;
Â  Â  Â  Â  Â  Â  font-family: 'Harry P', sans-serif;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  }
Â  Â  Â  Â  #get-riddle-btn::before {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: -50%;
Â  Â  Â  Â  Â  Â  left: -50%;
Â  Â  Â  Â  Â  Â  width: 200%;
Â  Â  Â  Â  Â  Â  height: 200%;
Â  Â  Â  Â  Â  Â  background: radial-gradient(circle, rgba(255,255,255,0.3) 10%, transparent 10.1%);
Â  Â  Â  Â  Â  Â  background-size: 15px 15px;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.5s ease;
Â  Â  Â  Â  Â  Â  animation: sparkle 3s infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  #get-riddle-btn:hover::before {
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  }
Â  Â  Â  Â  #get-riddle-btn:hover {
Â  Â  Â  Â  Â  Â  transform: scale(1.1) rotateX(15deg) rotateY(15deg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 40px rgba(255,215,0,1), inset 0 0 20px rgba(255,255,255,0.6);
Â  Â  Â  Â  }
Â  Â  Â  Â  #get-riddle-btn:active {
Â  Â  Â  Â  Â  Â  transform: scale(0.95) rotateX(10deg) rotateY(10deg);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(255,215,0,0.6), inset 0 0 10px rgba(255,255,255,0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 640px) {
Â  Â  Â  Â  Â  Â  #get-riddle-btn {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 1rem 2.5rem;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes float {
Â  Â  Â  Â  Â  Â  0% { transform: translateY(0px) rotateX(0deg); }
Â  Â  Â  Â  Â  Â  50% { transform: translateY(-5px) rotateX(3deg); }
Â  Â  Â  Â  Â  Â  100% { transform: translateY(0px) rotateX(0deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes leaderboard-float {
Â  Â  Â  Â  Â  Â  0% { transform: rotateX(5deg) rotateY(10deg) translateY(0); }
Â  Â  Â  Â  Â  Â  50% { transform: rotateX(8deg) rotateY(5deg) translateY(-3px); }
Â  Â  Â  Â  Â  Â  100% { transform: translateY(0px) rotateX(5deg) rotateY(10deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes pulse {
Â  Â  Â  Â  Â  Â  0% { transform: scale(1); }
Â  Â  Â  Â  Â  Â  50% { transform: scale(1.1); }
Â  Â  Â  Â  Â  Â  100% { transform: scale(1); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes button-float {
Â  Â  Â  Â  Â  Â  0% { transform: translateY(0px) rotateX(0deg) rotateY(0deg); }
Â  Â  Â  Â  Â  Â  50% { transform: translateY(-10px) rotateX(15deg) rotateY(15deg); }
Â  Â  Â  Â  Â  Â  100% { transform: translateY(0px) rotateX(0deg) rotateY(0deg); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes sparkle {
Â  Â  Â  Â  Â  Â  0% { transform: translate(0, 0); }
Â  Â  Â  Â  Â  Â  50% { transform: translate(10%, 10%); }
Â  Â  Â  Â  Â  Â  100% { transform: translate(0, 0); }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="flex flex-col min-h-screen relative">
Â  Â  <div id="parallax-bg"></div>

Â  Â  <header class="header flex justify-between items-center w-full z-10">
Â  Â  Â  Â  <h1 class="text-2xl font-['Harry_P'] text-yellow-400 sm:text-3xl md:text-4xl">Riddle Questâš¡ï¸</h1>
Â  Â  Â  Â  <div class="flex items-center space-x-2 sm:space-x-4">
Â  Â  Â  Â  Â  Â  <span id="score-display" class="text-base sm:text-xl">Points: 0</span>
Â  Â  Â  Â  Â  Â  <button id="logout-btn" onclick="safeLogout()" class="px-2 py-1 bg-red-800 text-white rounded hover:bg-red-700"><i class="fas fa-sign-out-alt"></i></button>Â 
Â  Â  Â  Â  Â  Â  <button id="mute-btn" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700"><i class="fas fa-volume-up"></i></button>
Â  Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <main class="flex flex-1 overflow-hidden main-content">
Â  Â  Â  Â  <section class="flex-1 flex flex-col items-center justify-start p-2 sm:p-4 parallax">
Â  Â  Â  Â  Â  Â  <button id="get-riddle-btn" class="btn-glow">Get Riddle</button>
Â  Â  Â  Â  Â  Â  <div id="progress-map" class="progress-map flex justify-center mb-4 sm:mb-6 hidden"></div>

Â  Â  Â  Â  Â  Â  <div class="riddle-card relative hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-inner w-full h-full flex flex-col justify-center items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-front flex flex-col justify-center items-center text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="riddle-text" class="text-base sm:text-lg md:text-xl mb-2 sm:mb-4 font-bold"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="answer-input" type="text" placeholder="ENTER ANSWER IN CAPS" class="p-2 rounded bg-gray-900 border border-yellow-400 text-white uppercase input-glow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="submit-answer" class="mt-2 sm:mt-4 px-4 sm:px-6 py-1 sm:py-2 bg-yellow-600 text-black rounded-lg font-bold btn-glow">Cast Spell</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="attempts-text" class="mt-2 text-sm sm:text-base">Attempts left: 5</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="timer-text" class="mt-1 text-sm sm:text-base">Time: 0s</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-back flex flex-col justify-center items-center text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="back-text" class="text-base sm:text-lg md:text-xl mb-2 sm:mb-4 font-bold"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <aside id="sidebar" class="sidebar p-2 sm:p-4 flex flex-col">
Â  Â  Â  Â  Â  Â  <h2 class="text-lg sm:text-xl md:text-2xl mb-2 border-b border-yellow-400 pb-1">Leaderboard</h2>
Â  Â  Â  Â  Â  Â  <ul id="leaderboard-list" class="space-y-2"></ul>
Â  Â  Â  Â  Â  Â  <div id="team-stats" class="mt-4 sm:mt-6 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-base sm:text-lg md:text-xl mb-2">Your Wand Stats</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <ul id="stats-list" class="space-y-1 text-xs sm:text-sm"></ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </aside>
Â  Â  Â  Â  <button id="sidebar-toggle" class="sidebar-toggle"><i class="fas fa-bars"></i></button>
Â  Â  </main>

Â  Â  <audio id="correct-sound" src="https://www.soundjay.com/buttons/button-3.mp3"></audio>
Â  Â  <audio id="wrong-sound" src="https://www.soundjay.com/buttons/button-10.mp3"></audio>

<script>
// ------------------------- ğŸ”¥ UPDATED FIREBASE CONFIGURATION (Mystery Maze) ğŸ”¥ -------------------------
// NOTE: Google Apps Script (GAS) functionality has been removed for speed.
const firebaseConfig = {
Â  Â  // UPDATED PROJECT DETAILS: mystery-maze-66d38
Â  Â  apiKey: "AIzaSyCcrlrS6mntArhEmMfOYCj4cIiDuAIiA7o",Â 
Â  Â  authDomain: "mystery-maze-66d38.firebaseapp.com",
Â  Â  projectId: "mystery-maze-66d38",
Â  Â  storageBucket: "mystery-maze-66d38.firebasestorage.app",
Â  Â  messagingSenderId: "499137595833",
Â  Â  appId: "1:499137595833:web:ac246bd44e4f391987ce68",
Â  Â  measurementId: "G-T6LP1TWK80"
};

// Initialize Firebase and Firestore
const app = firebase.initializeApp(firebaseConfig);
const db = app.firestore(); // 'db' variable ab Firestore database ko point karega
// ------------------------- END FIREBASE CONFIGURATION -------------------------

let team = {
Â  Â  id: null,
Â  Â  name: "Gryffindor",
Â  Â  score: 0
};
let userProgress = {};
const praises = ["Bravo!", "Excellent!", "Lightning fast!", "Well done!", "Impressive!", "Superb!", "Outstanding!", "Magnificent!", "Brilliant!", "Fantastic!"];
let allRiddles = [];
let teamRiddles = [];
let currentRiddleIndex = 0;
let attemptsUsed = 0;
let maxAttempts = 5;
let attemptsLeft = maxAttempts;
let timer = 0;
let timerInterval = null;
let muted = false;
let mouseX = 0, mouseY = 0;
let targetX = 0, targetY = 0;

// ------------------------- ELEMENTS -------------------------
const riddleText = document.getElementById('riddle-text');
const answerInput = document.getElementById('answer-input');
const submitBtn = document.getElementById('submit-answer');
const attemptsText = document.getElementById('attempts-text');
const timerText = document.getElementById('timer-text');
const backText = document.getElementById('back-text');
const leaderboardList = document.getElementById('leaderboard-list');
const progressMap = document.getElementById('progress-map');
const cardInner = document.querySelector('.card-inner');
const muteBtn = document.getElementById('mute-btn');
const teamStats = document.getElementById('team-stats');
const statsList = document.getElementById('stats-list');
const correctSound = document.getElementById('correct-sound');
const wrongSound = document.getElementById('wrong-sound');
const scoreDisplay = document.getElementById('score-display');
const parallaxElements = document.querySelectorAll('.parallax');
const parallaxBg = document.getElementById('parallax-bg');
const getRiddleBtn = document.getElementById('get-riddle-btn');
const riddleCard = document.querySelector('.riddle-card');
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebar-toggle');

// ------------------------- UNIQUE USER IDENTIFIER & SEEDED SHUFFLE -------------------------
function getUserId() {
Â  Â  return localStorage.getItem('roll');
}

function hashString(str) {
Â  Â  let hash = 0;
Â  Â  for (let i = 0; i < str.length; i++) {
Â  Â  Â  Â  const char = str.charCodeAt(i);
Â  Â  Â  Â  hash = (hash << 5) - hash + char;
Â  Â  Â  Â  hash |= 0;
Â  Â  }
Â  Â  return hash;
}

function mulberry32(seed) {
Â  Â  return function() {
Â  Â  Â  Â  let t = seed += 0x6D2B79F5;
Â  Â  Â  Â  t = Math.imul(t ^ (t >>> 15), t | 1);
Â  Â  Â  Â  t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
Â  Â  Â  Â  return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
Â  Â  };
}

function shuffleArray(array, seed) {
Â  Â  const rand = mulberry32(hashString(seed));
Â  Â  for (let i = array.length - 1; i > 0; i--) {
Â  Â  Â  Â  const j = Math.floor(rand() * (i + 1));
Â  Â  Â  Â  [array[i], array[j]] = [array[j], array[i]];
Â  Â  }
Â  Â  return array;
}

// ------------------------- SIDEBAR TOGGLE -------------------------
sidebarToggle.addEventListener('click', () => {
Â  Â  sidebar.classList.toggle('open');
Â  Â  sidebarToggle.innerHTML = sidebar.classList.contains('open') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
});

// ------------------------- ğŸ”¥ FIREBASE GLOBAL PROGRESS FUNCTIONS ğŸ”¥ -------------------------

// NEW: Progress ko Firebase se load karega
async function loadGlobalProgress() {
Â  Â  try {
Â  Â  Â  Â  const docRef = db.collection("progress").doc(team.id);Â 
Â  Â  Â  Â  const docSnap = await docRef.get();

Â  Â  Â  Â  if (docSnap.exists) {
Â  Â  Â  Â  Â  Â  console.log("Progress loaded from Firebase.");
Â  Â  Â  Â  Â  Â  return docSnap.data();Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.log("No progress found in Firebase for this user.");
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Failed to load progress from Firebase:", error);
Â  Â  Â  Â  return null;
Â  Â  }
}

// UPDATED: Progress ko Firebase par Transaction ke saath save karega
async function saveGlobalProgress() {
Â  Â  if (!team.id) return;
Â  Â  const progressRef = db.collection("progress").doc(team.id);

Â  Â  try {
Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  Â  // Transaction ensures data integrity across multiple devices
Â  Â  Â  Â  Â  Â  transaction.set(progressRef, userProgress);
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log("Progress saved via transaction.");

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Failed to save progress via transaction:", error);
Â  Â  }
}

// ------------------------- GRACEFUL LOGOUT FUNCTION (CRITICAL FOR SESSION LOCK) -------------------------
async function safeLogout() {
Â  Â  const rollNumber = localStorage.getItem('roll');

Â  Â  if (rollNumber) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const statusRef = db.collection("onlineStatus").doc(rollNumber);
Â  Â  Â  Â  Â  Â  // ğŸ’¥ Explicitly set isOnline to false
Â  Â  Â  Â  Â  Â  await statusRef.set({Â 
Â  Â  Â  Â  Â  Â  Â  Â  isOnline: false,Â 
Â  Â  Â  Â  Â  Â  Â  Â  logoutTime: firebase.firestore.FieldValue.serverTimestamp()Â 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  console.log("Firebase status successfully set to offline.");
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Failed to set status offline on logout:", error);
Â  Â  Â  Â  Â  Â  // We ignore the error and proceed to logout locally
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 2. Clear Local Storage and Redirect
Â  Â  localStorage.removeItem('roll');
Â  Â  alert("You have been securely logged out. You can now log in on another device.");
Â  Â  window.location.href = 'login.html';
}

// NEW: Event listener for when the browser/tab is closed/reloaded
window.addEventListener('beforeunload', (e) => {
Â  Â  const rollNumber = localStorage.getItem('roll');
Â  Â  if (rollNumber) {
Â  Â  Â  Â  // Use an asynchronous call that the browser might process before closing
Â  Â  Â  Â  db.collection("onlineStatus").doc(rollNumber).set({ isOnline: false });
Â  Â  }
});
// ------------------------- END LOGOUT HANDLERS -------------------------

// ------------------------- ğŸ”¥ NEW FIREBASE SCORE & LEADERBOARD FUNCTIONS ğŸ”¥ -------------------------

// NEW: 1. Firestore à¤®à¥‡à¤‚ à¤¸à¥à¤•à¥‹à¤° à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¤°à¥‡à¤‚
async function updateScoreInFirebase(points) {
Â  Â  const teamRef = db.collection("teamScores").doc(team.id);
Â  Â  await teamRef.update({
Â  Â  Â  Â  score: firebase.firestore.FieldValue.increment(points) // à¤¸à¥à¤•à¥‹à¤° à¤¬à¤¢à¤¼à¤¾à¤à¤
Â  Â  });
}

// NEW: 2. Firestore à¤¸à¥‡ à¤¸à¥à¤•à¥‹à¤° à¤¡à¤¿à¤¸à¥à¤ªà¥à¤²à¥‡ à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¤°à¥‡à¤‚
async function updateScoreDisplayFirebase() {
Â  Â  try {
Â  Â  Â  Â  const teamRef = db.collection("teamScores").doc(team.id);
Â  Â  Â  Â  const docSnap = await teamRef.get();
Â  Â  Â  Â  if (docSnap.exists) {
Â  Â  Â  Â  Â  Â  team.score = docSnap.data().score || 0;
Â  Â  Â  Â  Â  Â  scoreDisplay.textContent = `Points: ${team.score}`;
Â  Â  Â  Â  Â  Â  team.name = docSnap.data().name || team.id;Â 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â // à¤¯à¤¦à¤¿ à¤°à¥‹à¤² à¤¨à¤‚à¤¬à¤° à¤Ÿà¥€à¤®à¤¸à¥à¤•à¥‹à¤° à¤®à¥‡à¤‚ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆ, à¤¤à¥‹ à¤¨à¤¯à¤¾ à¤¡à¥‰à¤•à¥à¤¯à¥‚à¤®à¥‡à¤‚à¤Ÿ à¤¬à¤¨à¤¾à¤à¤ (à¤¹à¤¾à¤²à¤¾à¤‚à¤•à¤¿ login.html à¤•à¥‹ à¤¯à¤¹ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¤¿à¤)
Â  Â  Â  Â  Â  Â  Â await teamRef.set({ name: team.id, score: 0 });
Â  Â  Â  Â  Â  Â  Â team.score = 0;
Â  Â  Â  Â  Â  Â  Â scoreDisplay.textContent = `Points: 0`;
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Failed to fetch score from Firebase:", error);
Â  Â  }
}

// NEW: 3. Real-time Leaderboard à¤¸à¥‡à¤Ÿà¤…à¤ª à¤•à¤°à¥‡à¤‚
function setupRealtimeLeaderboard() {
Â  Â  // onSnapshot à¤•à¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¤¤à¥‡ à¤¹à¥à¤, à¤¡à¥‡à¤Ÿà¤¾ à¤®à¥‡à¤‚ à¤¬à¤¦à¤²à¤¾à¤µ à¤¹à¥‹à¤¤à¥‡ à¤¹à¥€ à¤²à¥€à¤¡à¤°à¤¬à¥‹à¤°à¥à¤¡ à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤¹à¥‹à¤—à¤¾
Â  Â  db.collection("teamScores")
Â  Â  Â  .orderBy("score", "desc") // à¤¸à¥à¤•à¥‹à¤° à¤•à¥‡ à¤…à¤¨à¥à¤¸à¤¾à¤° à¤•à¥à¤°à¤®à¤¬à¤¦à¥à¤§ à¤•à¤°à¥‡à¤‚
Â  Â  Â  .onSnapshot((querySnapshot) => {
Â  Â  Â  Â  const data = [];
Â  Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  // à¤²à¥€à¤¡à¤°à¤¬à¥‹à¤°à¥à¤¡ à¤®à¥‡à¤‚ teamScores à¤¸à¥‡ à¤¨à¤¾à¤® à¤”à¤° à¤¸à¥à¤•à¥‹à¤° à¤¦à¤¿à¤–à¤¾à¤¤à¤¾ à¤¹à¥ˆ
Â  Â  Â  Â  Â  Â  data.push({ name: doc.data().name, score: doc.data().score });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Leaderboard List ko update karein
Â  Â  Â  Â  leaderboardList.innerHTML = data.map((t, index) => `
Â  Â  Â  Â  Â  Â  <li class="leaderboard-item flex justify-between p-2 rounded bg-gray-900 border border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <span><i class="fas fa-trophy mr-1 ${index === 0 ? 'text-yellow-400' : index === 1 ? 'text-gray-300' : 'text-orange-600'}"></i>${t.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span>${t.score} pts</span>
Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  `).join('');
Â  Â  });
}

// NEW: Firebase à¤¸à¥‡ à¤¸à¤­à¥€ à¤°à¤¿à¤¡à¤²à¥à¤¸ à¤²à¥‹à¤¡ à¤•à¤°à¤¨à¥‡ à¤•à¤¾ à¤«à¤‚à¤•à¥à¤¶à¤¨
async function fetchAllRiddlesFromFirebase() {
Â  Â  const riddlesSnapshot = await db.collection("riddles").get();
Â  Â  const riddles = [];
Â  Â  riddlesSnapshot.forEach(doc => {
Â  Â  Â  Â  // Document ID (R1, R2, à¤†à¤¦à¤¿) à¤•à¥‹ qid à¤•à¥‡ à¤°à¥‚à¤ª à¤®à¥‡à¤‚ à¤‰à¤ªà¤¯à¥‹à¤— à¤•à¤°à¥‡à¤‚
Â  Â  Â  Â  riddles.push({ qid: doc.id, ...doc.data() });Â 
Â  Â  });
Â  Â  return riddles;
}

// ------------------------- INIT GAME FUNCTION -------------------------
async function initGame() {
Â  Â  const rollNumber = getUserId();
Â  Â  if (!rollNumber) {
Â  Â  Â  Â  alert("Please log in to start the quest.");
Â  Â  Â  Â  window.location.href = 'login.html';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  team.id = rollNumber;

Â  Â  // ğŸš¨ SESSION STATUS CHECK (à¤µà¤¹à¥€ à¤°à¤¹à¥‡à¤—à¤¾)
Â  Â  try {
Â  Â  Â  Â  const statusRef = db.collection("onlineStatus").doc(team.id);
Â  Â  Â  Â  const statusSnap = await statusRef.get();
Â  Â  Â  Â  if (!statusSnap.exists || !statusSnap.data().isOnline) {
Â  Â  Â  Â  Â  Â  Â alert("Your session was closed on another device or did not start correctly. Please log in again.");
Â  Â  Â  Â  Â  Â  Â localStorage.removeItem('roll');
Â  Â  Â  Â  Â  Â  Â window.location.href = 'login.html';
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Session integrity check failed:", error);
Â  Â  }


Â  Â  getRiddleBtn.classList.add('hidden');
Â  Â  riddleCard.classList.remove('hidden');
Â  Â  progressMap.classList.remove('hidden');

Â  Â  try {
Â  Â  Â  Â  // ğŸ”„ Firebase à¤¸à¥‡ à¤¸à¥€à¤§à¥‡ à¤¸à¤­à¥€ à¤°à¤¿à¤¡à¤²à¥à¤¸ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¥‡à¤‚
Â  Â  Â  Â  allRiddles = await fetchAllRiddlesFromFirebase();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (allRiddles && allRiddles.length > 0) {
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ğŸ”„ Load progress from Firebase
Â  Â  Â  Â  Â  Â  const globalProgress = await loadGlobalProgress();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (globalProgress) {
Â  Â  Â  Â  Â  Â  Â  Â  userProgress = globalProgress;
Â  Â  Â  Â  Â  Â  Â  Â  teamRiddles = userProgress.riddleOrder;
Â  Â  Â  Â  Â  Â  Â  Â  currentRiddleIndex = userProgress.currentRiddleIndex;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Agar global progress nahi mila, toh naya progress generate karo aur save karo
Â  Â  Â  Â  Â  Â  Â  Â  let shuffledRiddles = shuffleArray([...allRiddles], team.id);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // â­ QUEST_SIZE: 10 à¤°à¤¿à¤¡à¤²à¥à¤¸ à¤ªà¤° à¤«à¤¿à¤•à¥à¤¸ à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾
Â  Â  Â  Â  Â  Â  Â  Â  const QUEST_SIZE = 10;Â 
Â  Â  Â  Â  Â  Â  Â  Â  teamRiddles = shuffledRiddles.slice(0, QUEST_SIZE);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  userProgress = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  riddleOrder: teamRiddles,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solvedRiddles: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  partialRiddles: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRiddleIndex: 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  await saveGlobalProgress(); // Naya progress globally Firebase par save karo
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  progressMap.innerHTML = '';
Â  Â  Â  Â  Â  Â  // Ensure progress map reflects the size of the 10-riddle quest
Â  Â  Â  Â  Â  Â  teamRiddles.forEach((riddle, index) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const span = document.createElement('i');
Â  Â  Â  Â  Â  Â  Â  Â  span.classList.add('fas', 'fa-circle', 'progress-icon', 'opacity-70');
Â  Â  Â  Â  Â  Â  Â  Â  if (userProgress.solvedRiddles[riddle.qid]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  span.classList.remove('opacity-70');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  span.classList.add('fa-check-circle', 'completed');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  span.style.color = '#00FF00';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  progressMap.appendChild(span);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ğŸš¨ à¤¨à¤¯à¤¾: à¤…à¤¬ à¤¸à¥à¤•à¥‹à¤° à¤¸à¥€à¤§à¥‡ Firebase à¤¸à¥‡ à¤…à¤ªà¤¡à¥‡à¤Ÿ à¤•à¤°à¥‡à¤‚ à¤”à¤° à¤²à¥€à¤¡à¤°à¤¬à¥‹à¤°à¥à¤¡ à¤¶à¥à¤°à¥‚ à¤•à¤°à¥‡à¤‚
Â  Â  Â  Â  Â  Â  await updateScoreDisplayFirebase();Â 
Â  Â  Â  Â  Â  Â  setupRealtimeLeaderboard();
Â  Â  Â  Â  Â  Â  loadRiddle();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Failed to fetch riddles from Firebase.");
Â  Â  Â  Â  Â  Â  riddleText.textContent = "Error loading riddles from Firebase. Check your 'riddles' collection.";
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Network or fetch error:", error);
Â  Â  Â  Â  riddleText.textContent = "Error connecting to the magical network. Please check your connection.";
Â  Â  }
}

// ------------------------- GET RIDDLE BUTTON LOGIC -------------------------
getRiddleBtn.addEventListener('click', initGame);

// ------------------------- MUTE TOGGLE -------------------------
muteBtn.addEventListener('click', () => {
Â  Â  muted = !muted;
Â  Â  muteBtn.innerHTML = muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
});

// ------------------------- TIMER -------------------------
function startTimer() {
Â  Â  timer = 0;
Â  Â  timerText.textContent = "Time: 0s";
Â  Â  clearInterval(timerInterval);
Â  Â  timerInterval = setInterval(() => {
Â  Â  Â  Â  timer++;
Â  Â  Â  Â  timerText.textContent = `Time: ${timer}s`;
Â  Â  }, 1000);
}

// ------------------------- LOAD RIDDLE -------------------------
function loadRiddle() {
Â  Â  saveGlobalProgress(); // Progress ko Firebase par update karo

Â  Â  if (currentRiddleIndex >= teamRiddles.length) { // Checks against the 10-riddle limit
Â  Â  Â  Â  showFinalLeaderboard();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  const currentRiddle = teamRiddles[currentRiddleIndex];

Â  Â  if (userProgress.solvedRiddles[currentRiddle.qid]) {
Â  Â  Â  Â  currentRiddleIndex++;
Â  Â  Â  Â  loadRiddle();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (userProgress.partialRiddles && userProgress.partialRiddles[currentRiddle.qid]) {
Â  Â  Â  Â  attemptsUsed = userProgress.partialRiddles[currentRiddle.qid].attemptsUsed;
Â  Â  Â  Â  attemptsLeft = maxAttempts - attemptsUsed;
Â  Â  } else {
Â  Â  Â  Â  attemptsUsed = 0;
Â  Â  Â  Â  attemptsLeft = maxAttempts;
Â  Â  }

Â  Â  attemptsText.textContent = `Attempts left: ${attemptsLeft}`;
Â  Â  answerInput.value = '';
Â  Â  riddleText.textContent = currentRiddle.question;
Â  Â  backText.textContent = '';
Â  Â  cardInner.style.transform = 'rotateY(0deg)';
Â  Â  submitBtn.disabled = false;
Â  Â  startTimer();
}

// ------------------------- SCORE LOGIC -------------------------
function calculatePoints(attempt) {
Â  Â  if (attempt === 1) return 10;
Â  Â  if (attempt === 2) return 8;
Â  Â  if (attempt === 3) return 6;
Â  Â  if (attempt === 4) return 4;
Â  Â  if (attempt === 5) return 2;
Â  Â  return 0;
}

// ------------------------- UPDATE PROGRESS -------------------------
function updateProgress(correct) {
Â  Â  const progressIcons = progressMap.querySelectorAll('.progress-icon');
Â  Â  if (progressIcons[currentRiddleIndex]) {
Â  Â  Â  Â  progressIcons[currentRiddleIndex].classList.remove('fa-circle', 'opacity-70');
Â  Â  Â  Â  progressIcons[currentRiddleIndex].classList.add(correct ? 'fa-check-circle' : 'fa-times-circle', 'completed');
Â  Â  Â  Â  progressIcons[currentRiddleIndex].style.color = correct ? '#00FF00' : '#FF0000';
Â  Â  }
}

// ------------------------- SUBMIT ANSWER (FINAL FAULT-TOLERANT VERSION) -------------------------
submitBtn.addEventListener('click', async () => {
    // 1. CRITICAL: Prevent double clicks and handle initial check
    if (submitBtn.disabled) {
        console.log("Button already disabled. Ignoring click.");
        return;
    }
    
    const userAnswer = answerInput.value.trim().toUpperCase();
    if (!userAnswer) return;

    submitBtn.disabled = true; // Disable immediately
    
    attemptsUsed++;
    let correct = false;
    let submissionTimeout; // Variable to hold the timeout ID
    const currentRiddle = teamRiddles[currentRiddleIndex];

    // 2. CRITICAL: Add a timeout to force button re-enablement if network hangs
    submissionTimeout = setTimeout(() => {
        if (submitBtn.disabled) {
            submitBtn.disabled = false;
            console.error("Submission Timeout: Firebase check failed to respond in 5s. Re-enabling button.");
            backText.textContent = "Network Timeout. Please try refreshing.";
            cardInner.style.transform = 'rotateY(180deg)'; // Show feedback
            setTimeout(() => { cardInner.style.transform = 'rotateY(0deg)'; }, 1500);
        }
    }, 5000); // Set timeout to 5 seconds

    try {
        // ğŸš€ Fetch answer from Firebase
        const answerSnap = await db.collection("riddles").doc(currentRiddle.qid).get();
        
        // If the fetch succeeds, clear the safety timeout
        clearTimeout(submissionTimeout); 

        const correctAnswer = answerSnap.exists ? answerSnap.data().answer.toUpperCase() : null;Â 

        if (correctAnswer && userAnswer === correctAnswer) {Â 
            // --- CORRECT ANSWER LOGIC ---
            correct = true;
            clearInterval(timerInterval);
            const points = calculatePoints(attemptsUsed);
            
            if (userProgress.partialRiddles) { delete userProgress.partialRiddles[currentRiddle.qid]; }
            userProgress.solvedRiddles[currentRiddle.qid] = { attempts: attemptsUsed, score: points };
            userProgress.currentRiddleIndex = currentRiddleIndex + 1;
            await saveGlobalProgress();

            await updateScoreInFirebase(points);Â 
            await updateScoreDisplayFirebase();

            const randomPraise = praises[Math.floor(Math.random() * praises.length)];
            backText.textContent = `${randomPraise} +${points} points`;
            if (!muted) correctSound.play();
            cardInner.style.transform = 'rotateY(180deg)';
            
            setTimeout(() => {
                updateProgress(correct);
                cardInner.style.transform = 'rotateY(0deg)';
                currentRiddleIndex++;
                loadRiddle();
            }, 2000);

        } else {
            // --- INCORRECT ANSWER LOGIC ---
            if (!muted) wrongSound.play();
            attemptsLeft--;
            attemptsText.textContent = `Attempts left: ${attemptsLeft}`;
            
            if (attemptsLeft > 0) {
                if (!userProgress.partialRiddles) userProgress.partialRiddles = {};
                userProgress.partialRiddles[currentRiddle.qid] = { attemptsUsed: attemptsUsed };
                await saveGlobalProgress();

                backText.textContent = `Incorrect! Try again.`;
                cardInner.style.transform = 'rotateY(180deg)';
                
                setTimeout(() => {
                    cardInner.style.transform = 'rotateY(0deg)';
                    backText.textContent = '';
                    submitBtn.disabled = false; // Re-enable for the next attempt
                }, 1500);
            } else {
                // Out of attempts logic...
                clearInterval(timerInterval);
                backText.textContent = `Out of attempts!`;
                cardInner.style.transform = 'rotateY(180deg)';
                updateProgress(correct);
                
                if (userProgress.partialRiddles) { delete userProgress.partialRiddles[currentRiddle.qid]; }
                userProgress.currentRiddleIndex = currentRiddleIndex + 1;
                await saveGlobalProgress(); 

                setTimeout(() => {
                    cardInner.style.transform = 'rotateY(0deg)';
                    currentRiddleIndex++;
                    loadRiddle();
                }, 2500);
            }
        }
    } catch (error) {
        // Handle all network/Firebase errors gracefully
        clearTimeout(submissionTimeout); 
        console.error('Error during answer check (Firebase or Network):', error);
        backText.textContent = `Network Error. Please try again.`;
        submitBtn.disabled = false; // Force re-enable button immediately on error
    }
});

// ------------------------- FINAL LEADERBOARD -------------------------
function showFinalLeaderboard() {
Â  Â  clearInterval(timerInterval);
Â  Â  riddleText.textContent = "ğŸ† Quest Completed! ğŸ†";
Â  Â  answerInput.style.display = 'none';
Â  Â  submitBtn.style.display = 'none';
Â  Â  attemptsText.style.display = 'none';
Â  Â  timerText.style.display = 'none';
Â  Â  backText.textContent = `Final Points: ${team.score}`;
Â  Â  cardInner.style.transform = 'rotateY(180deg)';
Â  Â Â 
Â  Â  teamStats.classList.remove('hidden');
Â  Â  statsList.innerHTML = Object.keys(userProgress.solvedRiddles).map(qid => {
Â  Â  Â  Â  const riddle = userProgress.solvedRiddles[qid];
Â  Â  Â  Â  const originalRiddle = allRiddles.find(r => r.qid === qid);Â 
Â  Â  Â  Â  const riddleName = originalRiddle ? `Riddle ${qid}` : `Riddle ${qid}`;

Â  Â  Â  Â  return `<li class="p-1 bg-gray-900 rounded border border-gray-700">${riddleName}: ${riddle.score} pts | ${riddle.attempts} attempts</li>`;
Â  Â  }).join('');

Â  Â  setTimeout(() => {
Â  Â  Â  Â  window.location.href = 'thankyou.html';
Â  Â  }, 10000);
}

// ------------------------- SMOOTH PARALLAX EFFECT -------------------------
function lerp(start, end, factor) {
Â  Â  return start + (end - start) * factor;
}

document.addEventListener('mousemove', (e) => {
Â  Â  const { clientX, clientY } = e;
Â  Â  const { innerWidth: w, innerHeight: h } = window;
Â  Â  targetX = (clientX / w * 2 - 1) * 5;
Â  Â  targetY = (clientY / h * 2 - 1) * 5;
});

document.addEventListener('touchmove', (e) => {
Â  Â  const touch = e.touches[0];
Â  Â  const { innerWidth: w, innerHeight: h } = window;
Â  Â  targetX = (touch.clientX / w * 2 - 1) * 5;
Â  Â  targetY = (touch.clientY / h * 2 - 1) * 5;
});

function updateParallax() {
Â  Â  mouseX = lerp(mouseX, targetX, 0.1);
Â  Â  mouseY = lerp(mouseY, targetY, 0.1);

Â  Â  parallaxElements.forEach(el => {
Â  Â  Â  Â  el.style.transform = `translate(${mouseX}px, ${mouseY}px)`;
Â  Â  });

Â  Â  parallaxBg.style.transform = `translate(${mouseX/2}px, ${mouseY/2}px) scale(1.2)`;
Â  Â  requestAnimationFrame(updateParallax);
}

// Start parallax animation
requestAnimationFrame(updateParallax);

// ------------------------- INIT -------------------------
// Check for user ID and initialize on load if found, otherwise the button starts the process.
if (getUserId()) {
Â  Â  window.onload = initGame;
} else {
Â  Â  // Show the button if not logged in, which will then redirect to login.
Â  Â  getRiddleBtn.classList.remove('hidden');
}

</script>
</body>
</html>
